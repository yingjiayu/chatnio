import{c as G,u as N,ak as P,j as e,B as f,n as C,Y as J,aM as X,aN as Y,r as g,aO as S,J as K,K as Q,O as W,P as Z,aP as ee,z as R,aQ as ae,aR as T,aS as se,aT as te,aU as H,aV as w,aW as re,d as ne,aX as le,aY as ie,aZ as de,a_ as oe,a$ as ce,b0 as me,b1 as pe,b2 as ue,b3 as xe,b4 as he,b5 as ge,b6 as fe,b7 as A,I,X as je,aJ as _,b8 as E,b9 as ye,ba as ke,T as F,bb as we,H as ve,bc as Ne,bd as Ce,be,bf as Me}from"./index.9642abf5.js";import{C as Se,a as Ie,b as ze,c as De,d as Pe}from"./command.6605a855.js";import{P as Te,a as Ae,b as _e}from"./popover.305b8e8e.js";import{C as Ee}from"./chevrons-up-down.562b365d.js";import{u as Re,a as He}from"./hook.09114b1f.js";import{A as Fe}from"./activity.bd5287d7.js";import{M as V}from"./minimize.4508267e.js";import{S as Ve}from"./save.4c791d10.js";/**
 * @license lucide-react v0.309.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=G("Import",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m8 11 4 4 4-4",key:"1dohi6"}],["path",{d:"M8 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-4",key:"1ywtjm"}]]);function Oe({value:a,onChange:t,list:x,placeholder:l,defaultOpen:r,className:n,align:o}){const{t:u}=N(),[i,h]=P.useState(r??!1),d=P.useMemo(()=>{const c=[...x,a??""].filter(s=>s);return[...new Set(c)]},[x]);return e.jsxs(Te,{open:i,onOpenChange:h,children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(f,{variant:"outline",role:"combobox","aria-expanded":i,className:C("w-[320px] max-w-[60vw] justify-between",n),children:[a||(l??""),e.jsx(Ee,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(_e,{className:"w-[320px] max-w-[60vw] p-0",align:o,children:e.jsxs(Se,{children:[e.jsx(Ie,{placeholder:l}),e.jsx(ze,{children:u("admin.empty")}),e.jsx(De,{children:d.map(c=>e.jsxs(Pe,{value:c,onSelect:()=>{t(c),h(!1)},children:[e.jsx(J,{className:C("mr-2 h-4 w-4",c===a?"opacity-100":"opacity-0")}),c]},c))})]})})]})}async function Ue(a){try{return(await X.post("/admin/market/update",a)).data}catch(t){return console.warn(t),{status:!1,error:Y(t)}}}const v=()=>fe(8);function Be(a,t){switch(t.type){case"set":return[...t.payload.map(s=>({...s,seed:v()}))];case"add":return[...a,{...t.payload,seed:v()}];case"add-multiple":return[...a,...t.payload.map(s=>({id:s.id||"",name:s.name||"",free:!1,auth:!1,description:s.description||"",high_context:s.high_context||!1,default:s.default||!1,tag:s.tag||[],avatar:s.avatar||w[0],seed:v()}))];case"new":return[...a,{id:"",name:"",free:!1,auth:!1,description:"",high_context:!1,default:!1,tag:[],avatar:w[0],seed:v()}];case"new-template":return[{id:t.payload.id,name:t.payload.name,free:!1,auth:!1,description:"",high_context:!1,default:!0,tag:[],avatar:w[0],seed:v()},...a];case"batch-new-template":return[...t.payload.map(s=>({id:s.id,name:s.name,free:!1,auth:!1,description:"",high_context:!1,default:!0,tag:[],avatar:w[0],seed:v()})),...a];case"remove":let{idx:x}=t.payload;return[...a.slice(0,x),...a.slice(x+1)];case"update":let{index:l,data:r}=t.payload;return[...a.slice(0,l),r,...a.slice(l+1)];case"update-id":return[...a.map((s,m)=>m===t.payload.idx?{...s,id:t.payload.id}:s)];case"update-name":return[...a.map((s,m)=>m===t.payload.idx?{...s,name:t.payload.name}:s)];case"update-description":return[...a.map((s,m)=>m===t.payload.idx?{...s,description:t.payload.description}:s)];case"update-context":return[...a.map((s,m)=>m===t.payload.idx?{...s,high_context:t.payload.context}:s)];case"update-default":return[...a.map((s,m)=>m===t.payload.idx?{...s,default:t.payload.default}:s)];case"update-tags":return[...a.map((s,m)=>m===t.payload.idx?{...s,tag:t.payload.tags}:s)];case"add-tag":return[...a.map((s,m)=>{if(m===t.payload.idx){const k=s.tag||[];return k.push(t.payload.tag),{...s,tag:[...k]}}return s})];case"remove-tag":return[...a.map((s,m)=>{if(m===t.payload.idx){const k=s.tag||[];return{...s,tag:k.filter(M=>M!==t.payload.tag)}}return s})];case"set-avatar":return[...a.map((s,m)=>m===t.payload.idx?{...s,avatar:t.payload.avatar}:s)];case"replace":const{from:n,to:o}=t.payload,[u]=a.splice(n,1);return a.splice(o,0,u),[...a];case"add-below":return[...a.slice(0,t.payload.idx+1),{id:"",name:"",free:!1,auth:!1,description:"",high_context:!1,default:!1,tag:[],avatar:w[0],seed:v()},...a.slice(t.payload.idx+1)];case"upward":if(t.payload.idx===0)return a;const i=a[t.payload.idx];return a[t.payload.idx]=a[t.payload.idx-1],a[t.payload.idx-1]=i,[...a];case"downward":if(t.payload.idx===a.length-1)return a;const h=a[t.payload.idx];return a[t.payload.idx]=a[t.payload.idx+1],a[t.payload.idx+1]=h,[...a];case"move":const{fromIndex:d,toIndex:c}=t.payload,j=a[d];return a.splice(d,1),a.splice(c,0,j),[...a];default:throw new Error}}function Le({tag:a,idx:t,dispatch:x}){const{t:l}=N(),r=g.useMemo(()=>{const n=a||[];return ke.reduce((o,u)=>(o[u]=n.includes(u),o),{})},[a]);return e.jsx("div",{className:"market-tags",children:r&&Object.keys(r).map(n=>e.jsx(F,{variant:"outline",size:"sm",pressed:r[n],className:"market-tag",onPressedChange:o=>{x({type:o?"add-tag":"remove-tag",payload:{idx:t,tag:n}})},children:l(`tag.${n}`)},n))})}function qe({image:a,idx:t,dispatch:x}){const{t:l}=N(),[r,n]=g.useState(!1),[o,u]=g.useState(""),i=g.useMemo(()=>r?[...w,a]:w,[r,a]),h=d=>x({type:"set-avatar",payload:{idx:t,avatar:d}});return e.jsxs("div",{className:"market-image-wrapper",children:[e.jsx("div",{className:"market-images",children:i.map(d=>e.jsx(F,{variant:"outline",size:"sm",pressed:d===a,className:C("market-image",d===a?"active":""),onPressedChange:c=>{c&&(r&&n(!1),h(d))},children:d?e.jsx("img",{src:we(d)?o:`/icons/${d}`,alt:d}):e.jsx(ve,{className:"h-6 w-6"})},d))}),e.jsxs("div",{className:"market-custom-image",children:[e.jsxs("div",{className:"market-checkbox",children:[e.jsx(Ne,{checked:r,onCheckedChange:d=>{const c=!!d;n(c),h(c?o:w[0])}}),l("admin.market.custom-image")]}),e.jsx(I,{value:o,placeholder:l("admin.market.custom-image-placeholder"),onChange:d=>{u(d.target.value),h(d.target.value)},disabled:!r})]})]})}function Ge({model:a,form:t,stacked:x,dispatch:l,index:r,channelModels:n,forwardRef:o,...u}){const{t:i}=N(),[h,d]=g.useState(!1),c=g.useMemo(()=>a.id.trim().length>0&&a.name.trim().length>0,[a]);g.useEffect(()=>{d(x)},[x]);const j=({stacked:s})=>e.jsxs("div",{className:"market-row",children:[!s&&e.jsx("div",{className:"grow"}),e.jsx(f,{size:"icon",variant:"outline",onClick:()=>l({type:"add-below",payload:{idx:r}}),children:e.jsx(H,{className:"h-4 w-4"})}),!s&&e.jsx(f,{size:"icon",variant:"outline",onClick:()=>l({type:"upward",payload:{idx:r}}),disabled:r===0,children:e.jsx(Ce,{className:"h-4 w-4"})}),!s&&e.jsx(f,{size:"icon",variant:"outline",onClick:()=>l({type:"downward",payload:{idx:r}}),disabled:r===t.length-1,children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(f,{size:"icon",variant:"outline",onClick:()=>d(!h),children:h?e.jsx(R,{className:"h-4 w-4"}):e.jsx(V,{className:"h-4 w-4"})}),e.jsx(f,{size:"icon",onClick:()=>l({type:"remove",payload:{idx:r}}),children:e.jsx(Me,{className:"h-4 w-4"})})]});return h?e.jsx("div",{className:C("market-item",!c&&"error"),...u,ref:o,children:e.jsxs("div",{className:"model-wrapper",children:[e.jsxs("div",{className:"market-row",children:[e.jsxs("span",{children:[e.jsx(A,{}),i("admin.market.model-name")]}),e.jsx(I,{value:a.name,placeholder:i("admin.market.model-name-placeholder"),onChange:s=>{l({type:"update-name",payload:{idx:r,name:s.target.value}})}})]}),e.jsxs("div",{className:"market-row",children:[e.jsxs("span",{children:[e.jsx(A,{}),i("admin.market.model-id")]}),e.jsx(Oe,{value:a.id,onChange:s=>{l({type:"update-id",payload:{idx:r,id:s}})},className:"model-combobox",list:n,placeholder:i("admin.market.model-id-placeholder")})]}),e.jsxs("div",{className:"market-row",children:[e.jsx("span",{children:i("admin.market.model-description")}),e.jsx(je,{value:a.description||"",placeholder:i("admin.market.model-description-placeholder"),onChange:s=>{l({type:"update-description",payload:{idx:r,description:s.target.value}})}})]}),e.jsxs("div",{className:"market-row",children:[e.jsxs("span",{children:[i("admin.market.model-context"),e.jsx(_,{content:i("admin.market.model-context-tip")})]}),e.jsx(E,{className:"ml-auto",checked:a.high_context,onCheckedChange:s=>{l({type:"update-context",payload:{idx:r,context:s}})}})]}),e.jsxs("div",{className:"market-row",children:[e.jsxs("span",{children:[i("admin.market.model-is-default"),e.jsx(_,{content:i("admin.market.model-is-default-tip")})]}),e.jsx(E,{className:"ml-auto",checked:a.default,onCheckedChange:s=>{l({type:"update-default",payload:{idx:r,default:s}})}})]}),e.jsxs("div",{className:"market-row",children:[e.jsx("span",{children:i("admin.market.model-tag")}),e.jsx(Le,{tag:a.tag,idx:r,dispatch:l})]}),e.jsxs("div",{className:"market-row",children:[e.jsx("span",{children:i("admin.market.model-image")}),e.jsx(qe,{image:a.avatar,idx:r,dispatch:l})]}),e.jsx(j,{})]})}):e.jsxs("div",{className:C("market-item stacked",!c&&"error"),...u,ref:o,children:[e.jsx(ye,{className:"h-4 w-4 mr-2 cursor-pointer"}),e.jsx(I,{value:a.name,placeholder:i("admin.market.model-name-placeholder"),className:"grow mr-2",onChange:s=>{l({type:"update-name",payload:{idx:r,name:s.target.value}})}}),e.jsx(j,{stacked:!0})]})}function Je({form:a,dispatch:t,stacked:x,channelModels:l}){return a.map((r,n)=>e.jsx(re,{draggableId:r.seed,index:n,children:o=>e.jsx(Ge,{model:r,form:a,stacked:x,dispatch:t,index:n,channelModels:l,forwardRef:o.innerRef,...o.draggableProps,...o.dragHandleProps},n)},r.seed))}function Xe({open:a,setOpen:t,allModels:x,supportModels:l,onConfirm:r}){const{t:n}=N(),[o,u]=g.useState([]),{toast:i}=ne(),h=g.useMemo(()=>o.map(s=>s.id),[o]),d=g.useMemo(()=>l.filter(s=>h.includes(s.id)).map(s=>s.id),[h,l]),c=g.useMemo(()=>h.filter(s=>!d.includes(s)),[h,d]),j=g.useMemo(()=>c.filter(s=>x.includes(s)),[c,x]);return e.jsxs(e.Fragment,{children:[e.jsx(le,{open:o.length>0,onOpenChange:s=>{s||(t(!1),u([]))},children:e.jsxs(ie,{children:[e.jsxs(de,{children:[e.jsx(oe,{children:n("admin.market.sync-option")}),e.jsx(ce,{children:n("admin.market.sync-items",{length:h.length,exist:d.length,new:c.length,support:j.length})})]}),e.jsxs(me,{children:[e.jsx(f,{variant:"outline",loading:!0,onClick:async()=>{const s=o.filter(m=>c.includes(m.id));await r(s)&&(u([]),t(!1))},disabled:c.length===0,children:n("admin.market.sync-all",{length:c.length})}),e.jsx(f,{loading:!0,onClick:async()=>{const s=o.filter(m=>j.includes(m.id));await r(s)&&(u([]),t(!1))},disabled:j.length===0,children:n("admin.market.sync-self",{length:j.length})})]})]})}),e.jsx(pe,{title:n("admin.market.sync"),name:n("admin.market.sync-site"),placeholder:n("admin.market.sync-placeholder"),open:a,setOpen:t,type:ue.Text,defaultValue:"https://api.chatnio.net",onSubmit:async s=>{const m=xe("/v1/market",{endpoint:s}),k=await he({endpoint:s});return k.length===0?(i({title:n("admin.market.sync-failed"),description:n("admin.market.sync-failed-prompt",{endpoint:m})}),!1):(u(k),!1)}})]})}function Ye({open:a,models:t,onImport:x,onImportAll:l}){const{t:r}=N();return a&&t.length>0&&e.jsxs("div",{className:"market-alert",children:[e.jsxs("div",{className:"flex flex-row items-center mb-2 whitespace-nowrap select-none",children:[e.jsx(ge,{className:"h-4 w-4 mr-2 translate-y-[1px]"}),e.jsx("span",{children:r("admin.market.not-use")}),e.jsxs(f,{variant:"outline",size:"sm",className:"ml-auto",onClick:l,children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),r("admin.market.import-all")]})]}),e.jsx("div",{className:"market-alert-wrapper",children:t.map((n,o)=>e.jsx(f,{variant:"outline",size:"sm",className:"text-sm",onClick:()=>x(n),children:n},o))})]})}function ra(){const{t:a}=N(),[t,x]=g.useState(!1),[l,r]=g.useState(!1),[n,o]=g.useState(!0),[u,i]=g.useReducer(Be,[]),[h,d]=g.useState(!1),{supportModels:c,update:j}=Re((p,y)=>{x(!p),p&&i({type:"set",payload:y})}),{allModels:s,channelModels:m,update:k}=He(p=>r(!p)),M=g.useMemo(()=>s.filter(p=>!u.map(y=>y.id).includes(p)),[u,s]),z=t||l,$=async()=>{await j(),await k()},O=async()=>{},U=p=>{const{destination:y,source:b}=p;if(!y||y.index===b.index||y.index===-1)return;const L=b.index,q=y.index;i({type:"move",payload:{fromIndex:L,toIndex:q}})},D=async()=>{const p=u.filter(b=>b.id.trim().length>0&&b.name.trim().length>0),y=await Ue(p);if(!y.status){S(a("admin.market.update-failed"),{description:a("admin.market.update-failed-prompt",{reason:y.error})});return}S(a("admin.market.update-success"),{description:a("admin.market.update-success-prompt")}),await O()},B=async p=>{p.length!==0&&i({type:"add-multiple",payload:[...p]})};return e.jsxs("div",{className:"market",children:[e.jsx(Xe,{open:h,setOpen:d,allModels:s,supportModels:c,onConfirm:async p=>(await B(p),S(a("admin.market.sync-success"),{description:a("admin.market.sync-success-prompt",{length:p.length})}),!0)}),e.jsxs(K,{className:"admin-card market-card",children:[e.jsx(Q,{children:e.jsx(W,{children:a("admin.market.title")})}),e.jsxs(Z,{children:[e.jsxs("div",{className:"market-actions flex flex-row items-center mb-4",children:[e.jsxs(f,{variant:"outline",className:"whitespace-nowrap",onClick:()=>d(!0),children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),a("admin.market.sync")]}),e.jsx("div",{className:"grow"}),e.jsx(f,{variant:"outline",size:"icon",className:"mr-2",onClick:()=>o(!n),children:e.jsx(ee,{icon:n?e.jsx(R,{}):e.jsx(V,{}),className:"h-4 w-4"})}),e.jsx(f,{size:"icon",variant:"outline",className:"mr-2",onClick:$,children:e.jsx(ae,{className:C("h-4 w-4",z&&"animate-spin")})}),e.jsx(f,{size:"icon",className:"mr-2",loading:!0,onClick:D,children:e.jsx(Ve,{className:"h-4 w-4"})})]}),e.jsx(Ye,{open:!z,models:M,onImport:p=>{i({type:"new-template",payload:{id:p,name:T(p)}})},onImportAll:()=>{i({type:"batch-new-template",payload:M.map(p=>({id:p,name:T(p)}))})}}),e.jsx(se,{onDragEnd:U,children:e.jsx(te,{droppableId:"market-list",children:p=>e.jsx("div",{className:"market-list cursor-default",...p.droppableProps,ref:p.innerRef,children:u.length>0?e.jsx(Je,{form:u,dispatch:i,stacked:n,channelModels:m}):e.jsx("p",{className:"align-center text-sm empty",children:a("admin.empty")})})})}),e.jsxs("div",{className:"market-footer flex flex-row items-center mt-4",children:[e.jsx("div",{className:"grow"}),e.jsxs(f,{size:"sm",variant:"outline",className:"mr-2",onClick:()=>i({type:"new"}),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),a("admin.market.new-model")]}),e.jsx(f,{size:"sm",onClick:D,loading:!0,children:a("admin.market.migrate")})]})]})]})]})}export{ra as default};
